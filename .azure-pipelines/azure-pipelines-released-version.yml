# This is used to test if the released version is in healthy state or not

pr: none

trigger: none

jobs:

- job: 'Build_Publish_Azure_CLI_Test_SDK'
  pool:
    vmImage: 'Ubuntu-16.04'

  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.7.0'
      architecture: 'x64'

  - template: templates/setup-ci-machine.yml

  - template: templates/build-publish-azure-cli-test-sdk.yml

- job: 'Run_Test'
  dependsOn : Build_Publish_Azure_CLI_Test_SDK
  pool:
    vmImage: 'Ubuntu-16.04'

  steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.7.0'
        architecture: 'x64'

    - script: pip install --pre azure-cli --extra-index-url https://azurecliprod.blob.core.windows.net/edge
      displayName: 'Install Azure CLI'

    - template: download-install-local-azure-test-sdk.yml

    - template: setup-ci-machine.yml

    - task: CmdLine@2
      displayName: 'Install azure devops extension from azure cli index'
      inputs:
        script: 'az extension add -n azure-devops --debug'

    - script: pytest --junitxml "TEST-results.xml"
      displayName: 'Run Tests'
    
    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**TEST-*.xml'
        searchFolder: '$(System.DefaultWorkingDirectory)/'
      condition: succeededOrFailed()